<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
                        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

  <changeSet id="00000000000001" author="mohammad">
    <createTable tableName="facility">
      <column name="id" type="bigint" autoIncrement="true" startWith="1500">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="type" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createTable tableName="role">
      <column name="id" type="bigint" autoIncrement="true" startWith="1500">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="name" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="type" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="facility_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint baseColumnNames="facility_id"
                             baseTableName="role"
                             constraintName="fk_role__facility_id"
                             referencedColumnNames="id"
                             referencedTableName="facility"
    />
    <createTable tableName="app_user">
      <column name="id" type="bigint" autoIncrement="true" startWith="1050">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="login" type="varchar(50)">
        <constraints unique="true" nullable="false" uniqueConstraintName="ux_user_login"/>
      </column>
      <column name="password_hash" type="varchar(60)"/>
      <column name="first_name" type="varchar(50)"/>
      <column name="last_name" type="varchar(50)"/>
      <column name="email" type="varchar(191)">
        <constraints unique="true" nullable="true" uniqueConstraintName="ux_user_email"/>
      </column>
      <column name="image_url" type="varchar(256)"/>
      <column name="activated" type="boolean" valueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="lang_key" type="varchar(10)"/>
      <column name="reset_key" type="varchar(20)"/>
      <column name="created_by" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
      <column name="created_date" type="timestamp"/>
      <column name="reset_date" type="timestamp">
        <constraints nullable="true"/>
      </column>
      <column name="last_modified_by" type="varchar(50)"/>
      <column name="last_modified_date" type="timestamp"/>
    </createTable>

    <createTable tableName="authority">
      <column name="name" type="varchar(50)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
    </createTable>
    <createTable tableName="user_role">
      <column name="user_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="role_id" type="bigint">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addPrimaryKey columnNames="user_id, role_id" tableName="user_role"/>
    <addForeignKeyConstraint baseColumnNames="user_id"
                             baseTableName="user_role"
                             constraintName="fk_user_role__user_id"
                             referencedColumnNames="id"
                             referencedTableName="app_user"/>

    <addForeignKeyConstraint baseColumnNames="role_id"
                             baseTableName="user_role"
                             constraintName="fk_user_role__role_id"
                             referencedColumnNames="id"
                             referencedTableName="role"/>

    <createTable tableName="role_authority">
      <column name="role_id" type="bigint">
        <constraints nullable="false"/>
      </column>
      <column name="authority_name" type="varchar(50)">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addPrimaryKey columnNames="role_id, authority_name" tableName="role_authority"/>

    <addForeignKeyConstraint baseColumnNames="role_id"
                             baseTableName="role_authority"
                             constraintName="fk_role_authority__role_id"
                             referencedColumnNames="id"
                             referencedTableName="role"/>
    <addForeignKeyConstraint baseColumnNames="authority_name"
                             baseTableName="role_authority"
                             constraintName="fk_role_authority__authority_name"
                             referencedColumnNames="name"
                             referencedTableName="authority"/>

<!--    <createTable tableName="user_authority">-->
<!--      <column name="user_id" type="bigint">-->
<!--        <constraints nullable="false"/>-->
<!--      </column>-->

<!--      <column name="authority_name" type="varchar(50)">-->
<!--        <constraints nullable="false"/>-->
<!--      </column>-->
<!--    </createTable>-->

<!--    <addPrimaryKey columnNames="user_id, authority_name" tableName="user_authority"/>-->

<!--    <addForeignKeyConstraint baseColumnNames="authority_name"-->
<!--                             baseTableName="user_authority"-->
<!--                             constraintName="fk_authority_name"-->
<!--                             referencedColumnNames="name"-->
<!--                             referencedTableName="authority"/>-->

<!--    <addForeignKeyConstraint baseColumnNames="user_id"-->
<!--                             baseTableName="user_authority"-->
<!--                             constraintName="fk_user_id"-->
<!--                             referencedColumnNames="id"-->
<!--                             referencedTableName="app_user"/>-->

    <addNotNullConstraint columnName="password_hash"
                          columnDataType="varchar(60)"
                          tableName="app_user"/>
    <loadData
      file="config/liquibase/data/authority.csv"
      separator=";"
      tableName="authority"
      usePreparedStatements="true">
      <column name="name" type="string"/>
    </loadData>
    <loadData
      file="config/liquibase/data/facility.csv"
      separator=";"
      tableName="facility"
      usePreparedStatements="true">
      <column name="name" type="string"/>
      <column name="type" type="string"/>
    </loadData>
    <loadData
      file="config/liquibase/data/role.csv"
      separator=";"
      tableName="role"
      usePreparedStatements="true">
      <column name="name" type="string"/>
      <column name="type" type="string"/>
      <column name="facility_id" type="numeric"/>
    </loadData>
    <loadData
      file="config/liquibase/data/user.csv"
      separator=";"
      tableName="app_user"
      usePreparedStatements="true">
      <column name="id" type="numeric"/>
      <column name="activated" type="boolean"/>
      <column name="created_date" type="timestamp"/>
    </loadData>
    <loadData
      file="config/liquibase/data/role_authority.csv"
      separator=";"
      tableName="role_authority"
      usePreparedStatements="true">
      <column name="role_id" type="numeric"/>
    </loadData>
    <loadData
      file="config/liquibase/data/user_role.csv"
      separator=";"
      tableName="user_role"
      usePreparedStatements="true">
      <column name="user_id" type="numeric"/>
      <column name="role_id" type="numeric"/>
    </loadData>
    <dropDefaultValue tableName="app_user" columnName="created_date" columnDataType="${datetimeType}"/>
  </changeSet>

</databaseChangeLog>
